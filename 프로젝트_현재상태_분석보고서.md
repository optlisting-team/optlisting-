# OptListing í”„ë¡œì íŠ¸ í˜„ì¬ ìƒíƒœ ë¶„ì„ ë³´ê³ ì„œ

## ğŸ“‹ ë¶„ì„ ê°œìš”
í•˜ë“œì½”ë”© ì—†ëŠ” ì •ì„ì ì¸ êµ¬ì¡°ë¡œ ì¬êµ¬ì¶•ì„ ìœ„í•œ í˜„ì¬ ìƒíƒœ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.

---

## 1. ğŸ” í•˜ë“œì½”ë”© ì‹ë³„

### 1.1 ë°œê²¬ëœ í•˜ë“œì½”ë”© ìœ„ì¹˜

#### `default-user` ë¬¸ìì—´ í•˜ë“œì½”ë”©
**ì´ 80ê°œ ìœ„ì¹˜ì—ì„œ ë°œê²¬**

**ë°±ì—”ë“œ (`backend/`):**
- `backend/main.py`: **35ê°œ** - ëŒ€ë¶€ë¶„ì˜ API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
  - `@app.get("/api/listings")`: `user_id: str = "default-user"`
  - `@app.get("/api/analyze")`: `user_id: str = "default-user"`
  - `@app.post("/api/export")`: `user_id="default-user"`
  - ê¸°íƒ€ ë‹¤ìˆ˜ ì—”ë“œí¬ì¸íŠ¸

- `backend/services.py`: **3ê°œ**
  - `generate_export_csv()`: `user_id: str = "default-user"`
  - `upsert_listings()`: user_id ê²€ì¦ ë¡œì§ì—ì„œ "default-user" ì°¨ë‹¨

- `backend/ebay_webhook.py`: **11ê°œ**
  - `sync_ebay_listings()`: user_id ê²€ì¦ ë¡œì§
  - `ebay_auth_callback()`: user_id ì¶”ì¶œ ë° ê²€ì¦

- `backend/dummy_data.py`: **1ê°œ**
  - `generate_dummy_listings()`: `user_id: str = "default-user"`

**í”„ë¡ íŠ¸ì—”ë“œ (`frontend/`):**
- `frontend/src/components/Dashboard.jsx`: **1ê°œ** (ì£¼ì„ìœ¼ë¡œ ì‚¬ìš© ê¸ˆì§€ ëª…ì‹œ)
- `frontend/src/components/LowPerformingResults.jsx`: **1ê°œ**
- `frontend/src/components/SummaryCard.jsx`: **1ê°œ** - `const currentUserId = user?.id || 'default-user'`
- `frontend/src/components/Settings.jsx`: **1ê°œ**
- `frontend/src/components/Sidebar.jsx`: **2ê°œ**
- `frontend/src/contexts/AccountContext.jsx`: **1ê°œ**
- `frontend/src/components/PaymentSuccess.jsx`: **2ê°œ**

**ë¬¸ì„œ íŒŒì¼ (`.md`):**
- ë‹¤ìˆ˜ì˜ ë§ˆí¬ë‹¤ìš´ ë¬¸ì„œì—ì„œ ì˜ˆì‹œë¡œ ì‚¬ìš©ë¨

### 1.2 ê¸°íƒ€ í•˜ë“œì½”ë”©
- **"eBay" í”Œë«í¼ ë¬¸ìì—´**: ì—¬ëŸ¬ ê³³ì—ì„œ í•˜ë“œì½”ë”©ë¨
  - `backend/services.py`: `platform_filter: str = "eBay"`
  - `backend/models.py`: `marketplace = Column(String, nullable=True, default="eBay")`
  
- **ê²½ë¡œ/URL í•˜ë“œì½”ë”©**:
  - `backend/main.py`: `startup_event()`ì—ì„œ ì •ë¦¬ ë¡œì§ì— í•˜ë“œì½”ë”©ëœ SQL ì¿¼ë¦¬

### 1.3 ë¬¸ì œì 
1. **user_idê°€ Query íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë¨**: ëª¨ë“  API í˜¸ì¶œì—ì„œ `?user_id=xxx` í˜•íƒœë¡œ ì „ë‹¬ í•„ìš”
2. **ê¸°ë³¸ê°’ìœ¼ë¡œ "default-user" ì‚¬ìš©**: ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì— ëŒ€í•œ fallback ë¡œì§ ì¡´ì¬
3. **í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ í•˜ë“œì½”ë”©**: ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ `'default-user'` fallback ì‚¬ìš©

---

## 2. ğŸ” ì¸ì¦ ë° ì„¸ì…˜ ì²˜ë¦¬

### 2.1 eBay OAuth í† í° ì €ì¥ ìœ„ì¹˜

**í…Œì´ë¸”**: `profiles`
**ì»¬ëŸ¼**:
- `ebay_access_token` (String, nullable=True): Access Token (2ì‹œê°„ ë§Œë£Œ)
- `ebay_refresh_token` (String, nullable=True): Refresh Token (18ê°œì›” ë§Œë£Œ)
- `ebay_token_expires_at` (DateTime, nullable=True): Access Token ë§Œë£Œ ì‹œê°„
- `ebay_user_id` (String, nullable=True): eBay User ID
- `ebay_token_updated_at` (DateTime, nullable=True): í† í° ì—…ë°ì´íŠ¸ ì‹œê°„

**ì°¸ê³  ì½”ë“œ**:
```64:92:backend/models.py
class Profile(Base):
    __tablename__ = "profiles"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String, unique=True, nullable=False, index=True)  # ì‚¬ìš©ì ê³ ìœ  ID
    
    # Lemon Squeezy êµ¬ë… ì •ë³´
    ls_customer_id = Column(String, nullable=True, index=True)  # Lemon Squeezy Customer ID
    ls_subscription_id = Column(String, nullable=True, index=True)  # Lemon Squeezy Subscription ID
    subscription_status = Column(String, default='inactive')  # 'active', 'cancelled', 'expired', 'inactive'
    subscription_plan = Column(String, nullable=True)  # 'pro', 'free', etc.
    
    # í”Œëœ ì œí•œ
    total_listings_limit = Column(Integer, default=100)  # Pro í”Œëœ: ë¬´ì œí•œ ë˜ëŠ” í° ìˆ˜, Free: 100
    
    # í¬ë ˆë”§ ì‹œìŠ¤í…œ (3-Way Hybrid Pricing)
    purchased_credits = Column(Integer, default=0, nullable=False)  # ì´ êµ¬ë§¤/ë¶€ì—¬ í¬ë ˆë”§
    consumed_credits = Column(Integer, default=0, nullable=False)   # ì´ ì‚¬ìš© í¬ë ˆë”§
    current_plan = Column(String, default='free')  # 'free', 'starter', 'pro', 'enterprise'
    # free_tier_countëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜(add_free_tier_count.sql) ì‹¤í–‰ ì „ê¹Œì§€ ì£¼ì„ ì²˜ë¦¬
    # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í›„ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”:
    # free_tier_count = Column(Integer, default=0, nullable=False)  # ë¬´ë£Œí‹°ì–´ ì‚¬ìš© íšŸìˆ˜ (ìµœëŒ€ 3íšŒ)
    
    # eBay OAuth í† í°
    ebay_access_token = Column(String, nullable=True)  # eBay Access Token (2ì‹œê°„ ë§Œë£Œ)
    ebay_refresh_token = Column(String, nullable=True)  # eBay Refresh Token (18ê°œì›” ë§Œë£Œ)
    ebay_token_expires_at = Column(DateTime, nullable=True)  # Access Token ë§Œë£Œ ì‹œê°„
    ebay_user_id = Column(String, nullable=True)  # eBay User ID
    ebay_token_updated_at = Column(DateTime, nullable=True)
```

### 2.2 ìœ ì € ì‹ë³„ ë°©ì‹

**í˜„ì¬ êµ¬í˜„**: Query íŒŒë¼ë¯¸í„° ê¸°ë°˜**

- ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ `user_id`ë¥¼ **Query íŒŒë¼ë¯¸í„°**ë¡œ ë°›ìŒ
- JWT/Session/Cookie ê¸°ë°˜ ì¸ì¦ ì—†ìŒ
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¸ì¦ ì»¨í…ìŠ¤íŠ¸(`useAuth`)ì—ì„œ `user?.id`ë¥¼ ê°€ì ¸ì™€ì„œ API í˜¸ì¶œ ì‹œ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬

**ì˜ˆì‹œ**:
```605:606:backend/main.py
    user_id: str = "default-user",  # Default user ID for MVP phase
    db: Session = Depends(get_db)
```

**í”„ë¡ íŠ¸ì—”ë“œ ì˜ˆì‹œ**:
```126:128:frontend/src/components/Dashboard.jsx
  // Get actual user ID from auth context - CRITICAL: No fallback to 'default-user'
  // If user is not logged in, API calls will fail with proper error messages
  const currentUserId = user?.id
```

### 2.3 í† í° ê´€ë¦¬
- **ìë™ ê°±ì‹ **: `backend/workers/ebay_token_worker.py`ì—ì„œ 1ì‹œê°„ë§ˆë‹¤ ë§Œë£Œ ì˜ˆì • í† í° ìë™ ê°±ì‹ 
- **í† í° ì¡°íšŒ**: `backend/ebay_webhook.py`ì˜ `get_user_access_token()` í•¨ìˆ˜ë¡œ Profileì—ì„œ ì¡°íšŒ

### 2.4 ë¬¸ì œì 
1. **ë³´ì•ˆ ì·¨ì•½**: user_idë¥¼ Query íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ë©´ URLì— ë…¸ì¶œë¨
2. **ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì—†ìŒ**: ë°±ì—”ë“œì—ì„œ ìš”ì²­ìê°€ í•´ë‹¹ user_idë¥¼ ì‚¬ìš©í•  ê¶Œí•œì´ ìˆëŠ”ì§€ ê²€ì¦í•˜ì§€ ì•ŠìŒ
3. **JWT/Session ë¯¸ì‚¬ìš©**: í‘œì¤€ ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ

---

## 3. ğŸ“Š ë°ì´í„° ì¤‘ë³µ ë° ì œì•½ì¡°ê±´

### 3.1 í˜„ì¬ í…Œì´ë¸” êµ¬ì¡°

**`listings` í…Œì´ë¸”**:
```15:43:backend/models.py
class Listing(Base):
    __tablename__ = "listings"

    id = Column(Integer, primary_key=True, index=True)
    ebay_item_id = Column(String, unique=True, index=True, nullable=False)
    title = Column(String, nullable=False)
    sku = Column(String, nullable=False)
    image_url = Column(String, nullable=False)
    brand = Column(String, nullable=True)  # Brand name for forensic source detection
    upc = Column(String, nullable=True)  # UPC/EAN code for source identification
    marketplace = Column(String, nullable=True, default="eBay")  # "eBay", "Amazon", "Shopify", "Walmart"
    source = Column(String, nullable=False)  # "Amazon", "Walmart", "AliExpress", "CJ Dropshipping", "Home Depot", "Wayfair", "Costco", "Unknown"
    price = Column(Float, nullable=False)
    date_listed = Column(Date, nullable=False)
    sold_qty = Column(Integer, default=0)
    watch_count = Column(Integer, default=0)
    
    # JSONB fields (added via migration)
    metrics = Column(JSONB, default={}, nullable=True)
    analysis_meta = Column(JSONB, default={}, nullable=True)
    
    # Additional fields (added via migration)
    item_id = Column(String, nullable=True)  # Generic item ID (ebay_item_idì™€ ë³„ë„)
    platform = Column(String, nullable=True)  # Generic platform (marketplaceì™€ ë³„ë„)
    user_id = Column(String, nullable=True, index=True)
    supplier_id = Column(String, nullable=True)
    supplier_name = Column(String, nullable=True)
    last_synced_at = Column(DateTime, nullable=True)
    is_zombie = Column(Boolean, default=False, nullable=True)
```

### 3.2 ì œì•½ì¡°ê±´ ë¶„ì„

**í˜„ì¬ UNIQUE ì œì•½ì¡°ê±´**:
- `ebay_item_id`ì—ë§Œ UNIQUE ì œì•½ì¡°ê±´ ì¡´ì¬
- **`(user_id, ebay_item_id)` ë³µí•© ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ ì—†ìŒ**

**ìŠ¤í‚¤ë§ˆ í™•ì¸** (`supabase_schema.sql`):
```5:30:supabase_schema.sql
CREATE TABLE IF NOT EXISTS listings (
    id SERIAL PRIMARY KEY,
    ebay_item_id VARCHAR UNIQUE NOT NULL,
    ...
    user_id VARCHAR,
    ...
);
```

**ì¸ë±ìŠ¤ í™•ì¸**:
```49:53:supabase_schema.sql
CREATE INDEX IF NOT EXISTS idx_listings_ebay_item_id ON listings(ebay_item_id);
CREATE INDEX IF NOT EXISTS idx_listings_store_id ON listings(store_id);
CREATE INDEX IF NOT EXISTS idx_listings_user_id ON listings(user_id);
CREATE INDEX IF NOT EXISTS idx_listings_supplier_name ON listings(supplier_name);
CREATE INDEX IF NOT EXISTS idx_listings_metrics ON listings USING GIN (metrics);
```

### 3.3 ì¤‘ë³µ ë°©ì§€ ë¡œì§

**í˜„ì¬**: `upsert_listings()` í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
- PostgreSQLì˜ `ON CONFLICT` ì‚¬ìš©
- í•˜ì§€ë§Œ **`ebay_item_id`ë§Œ UNIQUE**ì´ë¯€ë¡œ, **ë™ì¼í•œ `ebay_item_id`ê°€ ë‹¤ë¥¸ `user_id`ì— ì¤‘ë³µ ì €ì¥ë  ìˆ˜ ì—†ìŒ**
- **ê°™ì€ ì‚¬ìš©ìê°€ ê°™ì€ `ebay_item_id`ë¥¼ ì—¬ëŸ¬ ë²ˆ ì €ì¥í•˜ëŠ” ê²ƒì€ ë°©ì§€ë¨**

**ë¬¸ì œì **:
1. `ebay_item_id`ê°€ ì „ì—­ì ìœ¼ë¡œ UNIQUEí•˜ë¯€ë¡œ, ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ eBay ì•„ì´í…œì„ ë™ê¸°í™”í•  ìˆ˜ ì—†ìŒ
2. `(user_id, ebay_item_id)` ë³µí•© ìœ ë‹ˆí¬ê°€ ì—†ì–´ì„œ ë…¼ë¦¬ì  ì¤‘ë³µì´ ê°€ëŠ¥í•  ìˆ˜ ìˆìŒ (í˜„ì¬ëŠ” ebay_item_id UNIQUEë¡œ ì¸í•´ ë¬¼ë¦¬ì  ì¤‘ë³µì€ ë¶ˆê°€)

---

## 4. ğŸ”„ eBay ë°ì´í„° í”Œë¡œìš°

### 4.1 GetMyeBaySelling í˜¸ì¶œ êµ¬ì¡°

**ì—”ë“œí¬ì¸íŠ¸**: `POST /api/ebay/listings/sync`
**í•¨ìˆ˜**: `sync_ebay_listings()` in `backend/ebay_webhook.py`

**ë™ê¸°í™” íë¦„**:
1. `sync_ebay_listings()` í˜¸ì¶œ
2. ë‚´ë¶€ì—ì„œ `get_active_listings_trading_api_internal()` ë°˜ë³µ í˜¸ì¶œ (í˜ì´ì§€ë„¤ì´ì…˜)
3. ê° í˜ì´ì§€ì—ì„œ `GetMyeBaySelling` API í˜¸ì¶œ
4. ê²°ê³¼ë¥¼ `upsert_listings()`ë¡œ DB ì €ì¥

**ì°¸ê³  ì½”ë“œ**:
```1361:1506:backend/ebay_webhook.py
async def sync_ebay_listings(
    request: Request,
    user_id: str = Query(..., description="User ID")
):
    """
    ğŸ”„ eBay Listings Sync - eBay ì—°ê²° í›„ ìë™ìœ¼ë¡œ listingsë¥¼ ê°€ì ¸ì™€ DBì— ì €ì¥
    
    OAuth ì—°ê²° ì„±ê³µ ì§í›„ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ì–´ ì‚¬ìš©ìì˜ eBay listingsë¥¼ ê°€ì ¸ì™€ DBì— ì €ì¥í•©ë‹ˆë‹¤.
    - Trading APIë¥¼ ì‚¬ìš©í•˜ì—¬ í™œì„± listings ê°€ì ¸ì˜¤ê¸°
    - DBì— upsert (ì¤‘ë³µ ì‹œ ì—…ë°ì´íŠ¸)
    - Summary stats ê°±ì‹ ì„ ìœ„í•´ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ fetchSummaryStats() ì¬í˜¸ì¶œ í•„ìš”
    """
```

**GetMyeBaySelling í˜¸ì¶œ ì½”ë“œ**:
```2083:2096:backend/ebay_webhook.py
        # GetMyeBaySelling XML Request
        xml_request = f"""<?xml version="1.0" encoding="utf-8"?>
<GetMyeBaySellingRequest xmlns="urn:ebay:apis:eBLBaseComponents">
    <RequesterCredentials>
        <eBayAuthToken>{access_token}</eBayAuthToken>
    </RequesterCredentials>
    <ActiveList>
        <Include>true</Include>
        <Pagination>
            <EntriesPerPage>{entries_per_page}</EntriesPerPage>
            <PageNumber>{page}</PageNumber>
        </Pagination>
    </ActiveList>
    <DetailLevel>ReturnAll</DetailLevel>
</GetMyeBaySellingRequest>"""
```

### 4.2 ê²½ëŸ‰ í˜¸ì¶œ vs ì „ì²´ ë™ê¸°í™” ë¶„ë¦¬ ì—¬ë¶€

**í˜„ì¬ ìƒíƒœ**: **ë¶„ë¦¬ë˜ì§€ ì•ŠìŒ**

- `sync_ebay_listings()`: ì „ì²´ ë™ê¸°í™”ë§Œ ìˆ˜í–‰
- **ê°œìˆ˜ë§Œ ê°€ì ¸ì˜¤ëŠ” ê²½ëŸ‰ í˜¸ì¶œ ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ**
- Summary ì¹´ë“œì˜ ê°œìˆ˜ ì¡°íšŒë„ ì „ì²´ ë™ê¸°í™”ë¥¼ í†µí•´ ê³„ì‚°

**ë¬¸ì œì **:
1. Summary í†µê³„ë¥¼ ìœ„í•´ ë§¤ë²ˆ ì „ì²´ ë™ê¸°í™” í•„ìš” (ë¹„íš¨ìœ¨ì )
2. ê°œìˆ˜ë§Œ í•„ìš”í•œ ê²½ìš°ì—ë„ ì „ì²´ ì•„ì´í…œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨

---

## 5. ğŸ“¦ Shopify ë‚´ë³´ë‚´ê¸° ë¡œì§

### 5.1 CSV ìƒì„± í•¨ìˆ˜

**ì£¼ìš” í•¨ìˆ˜**: `generate_export_csv()` in `backend/services.py`

**ìœ„ì¹˜**:
```1784:1802:backend/services.py
def generate_export_csv(
    listings,
    target_tool: str,
    db: Optional[Session] = None,
    user_id: str = "default-user",
    mode: str = "delete_list",
    store_id: Optional[str] = None
) -> str:
    """
    CSV Export for Dropshipping Automation Tools Only
    
    CSV í¬ë§·ì€ DBì—ì„œ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    ê° ê³µê¸‰ì²˜ë³„ ê³µì‹ í¬ë§·ì— ë§ì¶° ë°ì´í„°ë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤.
    
    Supported export formats (DBì—ì„œ ê´€ë¦¬):
    1. AutoDS: Headers: "Source ID", "File Action" | Data: supplier_id, "delete"
    2. Wholesale2B: Headers: "SKU", "Action" | Data: sku, "Delete"
    3. Shopify (Matrixify/Excelify): Headers: "ID", "Command" | Data: item_id, "DELETE"
    4. Shopify (Tagging Method): Headers: "Handle", "Tags" | Data: handle/sku, "OptListing_Delete"
```

### 5.2 Handleê³¼ SKU ìƒì„± ê·œì¹™

**Handle ìƒì„± ë¡œì§**:
```1924:1946:backend/services.py
            # Try to get handle from raw_data or use SKU as fallback
            raw_data = listing.get("raw_data", {})
            if isinstance(raw_data, str):
                try:
                    raw_data = json.loads(raw_data)
                except:
                    raw_data = {}
            handle = (raw_data.get("handle") if raw_data else None) or sku
```

**SKU ì¶”ì¶œ**:
```1919:1934:backend/services.py
            sku = listing.get("sku") or ""
            # supplier_id: ê¸°ë³¸ê°’ ë¹ˆ ë¬¸ìì—´ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            supplier_id = listing.get("supplier_id") or ""
            supplier_name = listing.get("supplier_name") or listing.get("supplier") or listing.get("source") or "Unknown"
            platform = listing.get("platform") or listing.get("marketplace") or ""
            # Try to get handle from raw_data or use SKU as fallback
```

**ê·œì¹™ ìš”ì•½**:
1. **Handle**: `raw_data.handle` â†’ ì—†ìœ¼ë©´ `sku` ì‚¬ìš©
2. **SKU**: `listing.sku` í•„ë“œ ì§ì ‘ ì‚¬ìš©

### 5.3 CSV í¬ë§· ê´€ë¦¬

- CSV í¬ë§·ì€ `csv_formats` í…Œì´ë¸”ì—ì„œ ê´€ë¦¬
- ê° ë„êµ¬ë³„ ë§¤í•‘ ê·œì¹™ì´ DBì— ì €ì¥ë¨

---

## 6. ğŸ’³ í¬ë ˆë”§ ì‹œìŠ¤í…œ

### 6.1 í¬ë ˆë”§ ì²´í¬ ë° ì°¨ê° ìœ„ì¹˜

**íŒŒì¼**: `backend/credit_service.py`

**ì£¼ìš” í•¨ìˆ˜**:
- `check_credits()`: í¬ë ˆë”§ ì¶©ë¶„ ì—¬ë¶€ ê²€ì‚¬ (ì°¨ê° ì—†ìŒ)
- `deduct_credits_atomic()`: **ì›ìì  í¬ë ˆë”§ ì°¨ê°** (ë°±ì—”ë“œ íŠ¸ëœì­ì…˜ ë‚´)

### 6.2 íŠ¸ëœì­ì…˜ ì²˜ë¦¬

**í˜„ì¬ êµ¬í˜„**: **ë°±ì—”ë“œ íŠ¸ëœì­ì…˜ ë‚´ì— ì¡´ì¬** âœ…

**ì›ìì  ì°¨ê° ë¡œì§**:
```144:303:backend/credit_service.py
def deduct_credits_atomic(
    db: Session,
    user_id: str,
    amount: int,
    description: Optional[str] = None,
    reference_id: Optional[str] = None
) -> CreditDeductResult:
    """
    ì›ìì  í¬ë ˆë”§ ì°¨ê° (ë™ì‹œì„± ì•ˆì „)
    
    ë¬´ë£Œí‹°ì–´ê°€ ë‚¨ì•„ìˆìœ¼ë©´ í¬ë ˆë”§ ì°¨ê° ì—†ì´ ì§„í–‰í•˜ê³  ë¬´ë£Œí‹°ì–´ ì¹´ìš´íŠ¸ ì¦ê°€
    ë¬´ë£Œí‹°ì–´ê°€ ëª¨ë‘ ì‚¬ìš©ë˜ë©´ ì¼ë°˜ í¬ë ˆë”§ ì°¨ê° ë¡œì§ ì‚¬ìš©
    
    PostgreSQLì˜ ì›ìì  UPDATEë¥¼ ì‚¬ìš©í•˜ì—¬ Race Condition ë°©ì§€
    """
```

**PostgreSQL ì›ìì  UPDATE ì‚¬ìš©**:
```235:248:backend/credit_service.py
        # âœ… ì›ìì  UPDATE (ë™ì‹œì„± ì•ˆì „)
        # WHERE ì ˆì—ì„œ ì”ì•¡ ê²€ì‚¬ë¥¼ í•¨ê»˜ ìˆ˜í–‰í•˜ì—¬ Race Condition ë°©ì§€
        result = db.execute(
            text("""
                UPDATE profiles
                SET consumed_credits = consumed_credits + :amount,
                    updated_at = NOW()
                WHERE user_id = :user_id
                  AND (purchased_credits - consumed_credits) >= :amount
                RETURNING 
                    purchased_credits, 
                    consumed_credits,
                    (purchased_credits - consumed_credits) as remaining
            """),
            {"user_id": user_id, "amount": amount}
        )
```

### 6.3 í¬ë ˆë”§ ì‚¬ìš© íë¦„

**ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬**:
- API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ `deduct_credits_atomic()` í˜¸ì¶œ
- ë¶„ì„ ì‹œì‘ ì‹œ í¬ë ˆë”§ ì°¨ê°
- ì‹¤íŒ¨ ì‹œ ìë™ í™˜ë¶ˆ ë¡œì§ (ì¼ë¶€ êµ¬í˜„ë¨)

**í”„ë¡ íŠ¸ì—”ë“œ ì—­í• **:
- í¬ë ˆë”§ ì”ì•¡ ì¡°íšŒë§Œ ìˆ˜í–‰
- ì°¨ê°ì€ ë°±ì—”ë“œì—ì„œë§Œ ì²˜ë¦¬

### 6.4 ë¬¸ì œì 
1. **ë¶„ì„ ì‘ì—… ì‹¤íŒ¨ ì‹œ í™˜ë¶ˆ ë¡œì§ ë¶ˆì™„ì „**: ì¼ë¶€ ì¼€ì´ìŠ¤ì—ì„œë§Œ í™˜ë¶ˆ ì²˜ë¦¬
2. **í¬ë ˆë”§ ì°¨ê° íƒ€ì´ë°**: ì‘ì—… ì‹œì‘ ì „ ì°¨ê° â†’ ì‹¤íŒ¨ ì‹œ í™˜ë¶ˆ vs ì‘ì—… ì™„ë£Œ í›„ ì°¨ê° ì¤‘ ì„ íƒ í•„ìš”

---

## ğŸ“ ìš”ì•½ ë° ê¶Œì¥ì‚¬í•­

### ì£¼ìš” ë¬¸ì œì  ìš”ì•½

1. **í•˜ë“œì½”ë”© ê³¼ë‹¤**: `default-user`ê°€ 80ê°œ ìœ„ì¹˜ì—ì„œ ì‚¬ìš©ë¨
2. **ì¸ì¦ ë°©ì‹ ë¯¸í¡**: Query íŒŒë¼ë¯¸í„°ë¡œ user_id ì „ë‹¬, JWT/Session ë¯¸ì‚¬ìš©
3. **ë°ì´í„° ì œì•½ì¡°ê±´ ë¶€ì¡±**: `(user_id, ebay_item_id)` ë³µí•© ìœ ë‹ˆí¬ ì—†ìŒ
4. **ë°ì´í„° í”Œë¡œìš° ë¹„íš¨ìœ¨**: ê²½ëŸ‰ í˜¸ì¶œê³¼ ì „ì²´ ë™ê¸°í™”ê°€ ë¶„ë¦¬ë˜ì§€ ì•ŠìŒ
5. **í¬ë ˆë”§ ì‹œìŠ¤í…œ**: ë°±ì—”ë“œ íŠ¸ëœì­ì…˜ ë‚´ ì²˜ë¦¬ (âœ… ì–‘í˜¸)

### ì¬êµ¬ì¶• ì‹œ ê³ ë ¤ì‚¬í•­

1. **ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ë„ì…**: JWT ë˜ëŠ” Session ê¸°ë°˜ ì¸ì¦
2. **í•˜ë“œì½”ë”© ì œê±°**: í™˜ê²½ë³€ìˆ˜ ë° ì„¤ì • ê´€ë¦¬ ì‹œìŠ¤í…œ ë„ì…
3. **ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ì¡°ê±´ ê°•í™”**: ë³µí•© ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ ì¶”ê°€
4. **API ì—”ë“œí¬ì¸íŠ¸ ë¶„ë¦¬**: ê²½ëŸ‰ ì¡°íšŒ vs ì „ì²´ ë™ê¸°í™” ë¶„ë¦¬
5. **ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ **: í™˜ë¶ˆ ë¡œì§ ì™„ì „ì„± í™•ë³´

---

**ë¶„ì„ ì™„ë£Œì¼**: 2025-01-XX  
**ë¶„ì„ ëŒ€ìƒ**: ì „ì²´ í”„ë¡œì íŠ¸ ì½”ë“œë² ì´ìŠ¤

